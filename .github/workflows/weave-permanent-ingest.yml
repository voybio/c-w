name: Loom Board - Ingest Paid Tier Entry

on:
  repository_dispatch:
    types: [paid_weave, permanent_weave]
  workflow_dispatch:
    inputs:
      agent_id:
        description: Agent identifier
        required: true
      message:
        description: Board message
        required: true
      amount_usd:
        description: Contribution amount in USD (numeric)
        required: true
      tier:
        description: Tier id (day|3day|permanent|featured)
        required: true
        default: permanent
      provider:
        description: Payment provider (stripe|paypal|manual)
        required: false
        default: stripe
      source:
        description: Source label (manual/payment-provider)
        required: false
        default: manual

permissions:
  contents: write

jobs:
  ingest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Build payload
        id: payload
        shell: bash
        env:
          DISPATCH_PAYLOAD_JSON: ${{ toJson(github.event.client_payload) }}
          INPUT_AGENT_ID: ${{ inputs.agent_id }}
          INPUT_MESSAGE: ${{ inputs.message }}
          INPUT_AMOUNT_USD: ${{ inputs.amount_usd }}
          INPUT_TIER: ${{ inputs.tier }}
          INPUT_PROVIDER: ${{ inputs.provider }}
          INPUT_SOURCE: ${{ inputs.source }}
        run: |
          python3 - <<'PY'
          import json
          import os

          event_name = os.environ.get("GITHUB_EVENT_NAME", "")
          payload = {}
          if event_name == "repository_dispatch":
              payload = json.loads(os.environ.get("DISPATCH_PAYLOAD_JSON", "{}") or "{}")
              agent_id = str(payload.get("agent_id", "")).strip()
              message = str(payload.get("message", "")).strip()
              amount_usd = str(payload.get("amount_usd", "")).strip()
              tier = str(payload.get("tier", "permanent")).strip() or "permanent"
              provider = str(payload.get("provider", "stripe")).strip() or "stripe"
              source = str(payload.get("source", "repository_dispatch")).strip() or "repository_dispatch"
              purchase_id = str(payload.get("purchase_id", "")).strip()
          else:
              agent_id = os.environ.get("INPUT_AGENT_ID", "").strip()
              message = os.environ.get("INPUT_MESSAGE", "").strip()
              amount_usd = os.environ.get("INPUT_AMOUNT_USD", "").strip()
              tier = os.environ.get("INPUT_TIER", "permanent").strip() or "permanent"
              provider = os.environ.get("INPUT_PROVIDER", "stripe").strip() or "stripe"
              source = os.environ.get("INPUT_SOURCE", "manual").strip() or "manual"
              purchase_id = ""

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"agent_id={agent_id}\n")
              fh.write(f"amount_usd={amount_usd}\n")
              fh.write(f"tier={tier}\n")
              fh.write(f"provider={provider}\n")
              fh.write(f"source={source}\n")
              fh.write(f"purchase_id={purchase_id}\n")
              fh.write("message<<EOF\n")
              fh.write(message + "\n")
              fh.write("EOF\n")
          PY

      - name: Append paid entry
        run: |
          if [ -z "${{ steps.payload.outputs.agent_id }}" ] || [ -z "${{ steps.payload.outputs.message }}" ]; then
            echo "Missing agent_id or message; skipping."
            exit 0
          fi
          python3 scripts/board_engine.py add \
            --board board.json \
            --agent-id "${{ steps.payload.outputs.agent_id }}" \
            --message "${{ steps.payload.outputs.message }}" \
            --tier "${{ steps.payload.outputs.tier }}" \
            --amount-usd "${{ steps.payload.outputs.amount_usd }}" \
            --provider "${{ steps.payload.outputs.provider }}" \
            --purchase-id "${{ steps.payload.outputs.purchase_id }}" \
            --source "${{ steps.payload.outputs.source }}" \
            --max-message-len 280

      - name: Commit board update
        run: |
          if git diff --quiet -- board.json; then
            echo "No board update."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add board.json
          git commit -m "board: add paid weave (${{ steps.payload.outputs.tier }}) for ${{ steps.payload.outputs.agent_id }}"
          git push
